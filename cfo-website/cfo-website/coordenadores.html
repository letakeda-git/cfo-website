<!doctype html>
<html lang="pt">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Coordenadores • CFO</title>
    <meta name="description" content="Gestão de coordenadores do Clube Futsal de Oeiras." />
    <link rel="icon" type="image/x-icon" href="./favicon_io/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="./favicon_io/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="./favicon_io/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="./favicon_io/favicon-16x16.png" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="./styles.css" />
    <!-- API Client -->
    <script src="./api-client.js"></script>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a href="./index.html" class="logo">
          <img src="./public/logo-cfo.png" alt="Logótipo do CF Oeiras" />
          <span>Clube Futsal de Oeiras</span>
        </a>
        <div>
          <span id="user-info" class="user-info"></span>
          <button onclick="logout()" class="btn btn-outline btn-small">Sair</button>
        </div>
      </div>
    </header>

    <main>
      <section class="data-table">
        <div class="container">
          <div class="table-header">
            <div class="section-tabs">
              <button class="tab-button" onclick="switchTab('atletas')">Atletas</button>
              <button class="tab-button" onclick="switchTab('treinadores')">Treinadores</button>
              <button class="tab-button active" onclick="switchTab('coordenadores')">Coordenadores</button>
            </div>
            <div class="table-actions">
              <button onclick="loadCoordinators()" class="btn btn-outline" id="refresh-btn">
                <span id="refresh-text">Atualizar</span>
                <span id="refresh-loading" style="display: none;">A carregar...</span>
              </button>
              <button class="btn" onclick="openAddCoordinatorModal()">+ Adicionar Coordenador</button>
            </div>
          </div>
          
          <!-- Filtros -->
          <div class="filters-section">
            <div class="filters-row">
              <div class="filter-group">
                <label for="name-filter">Nome:</label>
                <input type="text" id="name-filter" placeholder="Filtrar por nome..." />
              </div>
              <div class="filter-group">
                <label for="team-filter">Equipa:</label>
                <select id="team-filter">
                  <option value="">Todas as equipas</option>
                  <option value="Seniores">Seniores</option>
                  <option value="Juniores">Juniores</option>
                  <option value="Juvenis">Juvenis</option>
                  <option value="Iniciados">Iniciados</option>
                  <option value="Infantis">Infantis</option>
                  <option value="Benjamins Sub-11">Benjamins Sub-11</option>
                  <option value="Benjamins Sub-10">Benjamins Sub-10</option>
                  <option value="Traquinas">Traquinas</option>
                  <option value="Petizes">Petizes</option>
                </select>
              </div>
              <div class="filter-group">
                <button id="clear-filters" class="btn btn-outline">Limpar Filtros</button>
              </div>
            </div>
          </div>
          
          <div class="table-container">
            <table class="admin-table" id="coordinators-table">
              <thead>
                <tr>
                  <th>Nome</th>
                  <th>Idade</th>
                  <th>Equipa</th>
                  <th>Telemóvel</th>
                  <th>Email</th>
                  <th>Data de Registo</th>
                  <th>Ações</th>
                </tr>
              </thead>
              <tbody id="coordinators-tbody">
                <tr id="loading-row">
                  <td colspan="8" style="text-align: center; padding: 20px;">
                    <span id="loading-text">A carregar coordenadores...</span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>
    </main>

    <!-- Add Coordinator Modal -->
    <div id="addCoordinatorModal" class="modal" style="display: none;">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Adicionar Novo Coordenador</h3>
          <button onclick="closeAddCoordinatorModal()" class="modal-close">&times;</button>
        </div>
        <form id="addCoordinatorForm" onsubmit="return handleAddCoordinator(event)">
          <div id="add-error-message" class="error-message" style="display: none;"></div>
          <div id="add-success-message" class="success-message" style="display: none;"></div>
          
          <label>
            <span>Nome Completo</span>
            <input type="text" name="name" id="add-name" placeholder="Nome completo do coordenador" required />
          </label>
          
          <label>
            <span>Idade</span>
            <input type="number" name="age" id="add-age" placeholder="Idade do coordenador" min="18" max="99" required />
          </label>
          
          <label>
            <span>Equipa</span>
            <select name="team" id="add-team" required>
              <option value="">Selecionar equipa</option>
              <option value="Seniores">Seniores</option>
              <option value="Juniores">Juniores</option>
              <option value="Juvenis">Juvenis</option>
              <option value="Iniciados">Iniciados</option>
              <option value="Infantis">Infantis</option>
              <option value="Benjamins Sub-11">Benjamins Sub-11</option>
              <option value="Benjamins Sub-10">Benjamins Sub-10</option>
              <option value="Traquinas">Traquinas</option>
              <option value="Petizes">Petizes</option>
            </select>
          </label>
          
          
          <label>
            <span>Número de Telemóvel</span>
            <input type="tel" name="mobile" id="add-mobile" placeholder="912 345 678" pattern="[0-9]{9}" required />
          </label>
          
          <label>
            <span>Email</span>
            <input type="email" name="email" id="add-email" placeholder="coordenador@exemplo.com" />
          </label>
          
          <div class="form-actions">
            <button type="submit" class="btn" id="add-submit-btn">
              <span id="add-btn-text">Adicionar Coordenador</span>
              <span id="add-btn-loading" style="display: none;">A adicionar...</span>
            </button>
            <button type="button" onclick="closeAddCoordinatorModal()" class="btn btn-outline">Cancelar</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Edit Coordinator Modal -->
    <div id="editCoordinatorModal" class="modal" style="display: none;">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Editar Coordenador</h3>
          <button onclick="closeEditCoordinatorModal()" class="modal-close">&times;</button>
        </div>
        <form id="editCoordinatorForm" onsubmit="return handleEditCoordinator(event)">
          <div id="edit-error-message" class="error-message" style="display: none;"></div>
          <div id="edit-success-message" class="success-message" style="display: none;"></div>
          
          <label>
            <span>Nome Completo</span>
            <input type="text" name="name" id="edit-name" placeholder="Nome completo do coordenador" required />
          </label>
          
          <label>
            <span>Idade</span>
            <input type="number" name="age" id="edit-age" placeholder="Idade do coordenador" min="18" max="99" required />
          </label>
          
          <label>
            <span>Equipa</span>
            <select name="team" id="edit-team" required>
              <option value="">Selecionar equipa</option>
              <option value="Seniores">Seniores</option>
              <option value="Juniores">Juniores</option>
              <option value="Juvenis">Juvenis</option>
              <option value="Iniciados">Iniciados</option>
              <option value="Infantis">Infantis</option>
              <option value="Benjamins Sub-11">Benjamins Sub-11</option>
              <option value="Benjamins Sub-10">Benjamins Sub-10</option>
              <option value="Traquinas">Traquinas</option>
              <option value="Petizes">Petizes</option>
            </select>
          </label>
          
          
          <label>
            <span>Número de Telemóvel</span>
            <input type="tel" name="mobile" id="edit-mobile" placeholder="912 345 678" pattern="[0-9]{9}" required />
          </label>
          
          <label>
            <span>Email</span>
            <input type="email" name="email" id="edit-email" placeholder="coordenador@exemplo.com" />
          </label>
          
          <div class="form-actions">
            <button type="submit" class="btn" id="edit-submit-btn">
              <span id="edit-btn-text">Atualizar Coordenador</span>
              <span id="edit-btn-loading" style="display: none;">A atualizar...</span>
            </button>
            <button type="button" onclick="closeEditCoordinatorModal()" class="btn btn-outline">Cancelar</button>
          </div>
        </form>
      </div>
    </div>

    <footer class="site-footer">
      <div class="container">
        <p>© <span id="year"></span> CFO. Todos os direitos reservados.</p>
      </div>
    </footer>

    <script>
      function logout() {
        if (window.apiClient) {
          window.apiClient.clearToken();
        }
        window.location.href = './login.html';
      }

      function checkAuth() {
        if (!window.apiClient || !window.apiClient.token) {
          window.location.href = './login.html';
          return;
        }

        // Display user information
        const token = window.apiClient.token;
        let userInfo = { email: 'Admin' }; // Default fallback
        
        if (token) {
          try {
            // Decode JWT token to get user info
            const payload = JSON.parse(atob(token.split('.')[1]));
            userInfo = {
              email: payload.username || payload.email || 'Admin',
              name: payload.name || payload.username || 'Admin'
            };
          } catch (error) {
            console.error('Error decoding token:', error);
          }
        }
        
        const userInfoEl = document.getElementById('user-info');
        if (userInfo && userInfoEl) {
          const displayName = userInfo.name || userInfo.email;
          userInfoEl.textContent = `Olá, ${displayName}`;
        }
      }

      async function switchTab(tabName) {
        // Remove active class from all tabs
        document.querySelectorAll('.tab-button').forEach(btn => {
          btn.classList.remove('active');
        });
        
        // Add active class to clicked tab
        event.target.classList.add('active');
        
        // Handle different tabs
        switch(tabName) {
          case 'atletas':
            // Redirect to players page
            window.location.href = './players.html';
            break;
          case 'treinadores':
            // Redirect to coaches page
            window.location.href = './coaches.html';
            break;
          case 'coordenadores':
            // Show coordinators table
            document.getElementById('coordinators-table').style.display = 'block';
            loadCoordinators();
            break;
        }
      }

      // Global variables
      let allCoordinators = [];
      let currentEditingCoordinatorId = null;
      let currentCoordinatorsList = [];

      async function loadCoordinators() {
        const refreshBtn = document.getElementById('refresh-btn');
        const refreshText = document.getElementById('refresh-text');
        const refreshLoading = document.getElementById('refresh-loading');
        
        // Show loading state
        if (refreshBtn) {
          refreshBtn.disabled = true;
          if (refreshText) refreshText.style.display = 'none';
          if (refreshLoading) refreshLoading.style.display = 'inline';
        }
        
        try {
          const result = await window.apiClient.getCoordinators();
          
          if (result.success) {
            allCoordinators = result.coordinators; // Store all coordinators
            displayCoordinators(result.coordinators);
          } else {
            showError('Erro ao carregar coordenadores: ' + result.error);
          }
        } catch (error) {
          console.error('Error loading coordinators:', error);
          showError('Erro de conexão ao carregar coordenadores.');
        } finally {
          // Hide loading state
          if (refreshBtn) {
            refreshBtn.disabled = false;
            if (refreshText) refreshText.style.display = 'inline';
            if (refreshLoading) refreshLoading.style.display = 'none';
          }
        }
      }

      // Filter coordinators
      function filterCoordinators() {
        const nameFilter = document.getElementById('name-filter').value.toLowerCase();
        const teamFilter = document.getElementById('team-filter').value;
        
        let filteredCoordinators = allCoordinators.filter(coordinator => {
          // Filter by name
          const nameMatch = !nameFilter || coordinator.name.toLowerCase().includes(nameFilter);
          
          // Filter by team
          const teamMatch = !teamFilter || coordinator.team === teamFilter;
          
          return nameMatch && teamMatch;
        });
        
        displayCoordinators(filteredCoordinators);
      }

      // Clear filters
      function clearFilters() {
        document.getElementById('name-filter').value = '';
        document.getElementById('team-filter').value = '';
        displayCoordinators(allCoordinators);
      }

      function displayCoordinators(coordinators) {
        const tbody = document.getElementById('coordinators-tbody');
        const loadingRow = document.getElementById('loading-row');
        
        // Store the coordinators list globally for edit functionality
        currentCoordinatorsList = coordinators;
        
        // Remove loading row
        if (loadingRow) {
          loadingRow.remove();
        }
        
        if (coordinators.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="8" style="text-align: center; padding: 20px; color: var(--muted);">
                Nenhum coordenador encontrado. <button onclick="openAddCoordinatorModal()" style="color: var(--brand); background: none; border: none; text-decoration: underline; cursor: pointer;">Adicionar primeiro coordenador</button>
              </td>
            </tr>
          `;
          return;
        }
        
        // Display coordinators
        tbody.innerHTML = coordinators.map(coordinator => `
          <tr>
            <td>${coordinator.name}</td>
            <td>${coordinator.age} anos</td>
            <td>${coordinator.team || '-'}</td>
            <td>${coordinator.mobile || '-'}</td>
            <td>${coordinator.email || '-'}</td>
            <td>${formatDate(coordinator.createdAt)}</td>
            <td>
              <div class="action-buttons">
                <button onclick="editCoordinator('${coordinator.coordinatorId}')" class="btn btn-outline btn-small">
                  Editar
                </button>
                <button onclick="deleteCoordinator('${coordinator.coordinatorId}', '${coordinator.name}')" class="btn btn-danger btn-small">
                  Eliminar
                </button>
              </div>
            </td>
          </tr>
        `).join('');
      }

      function formatDate(dateString) {
        try {
          const date = new Date(dateString);
          return date.toLocaleDateString('pt-PT', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit'
          });
        } catch (error) {
          return dateString;
        }
      }

      function showError(message) {
        const tbody = document.getElementById('coordinators-tbody');
        const loadingRow = document.getElementById('loading-row');
        
        if (loadingRow) {
          loadingRow.remove();
        }
        
        tbody.innerHTML = `
          <tr>
            <td colspan="8" style="text-align: center; padding: 20px; color: var(--brand);">
              ${message}
            </td>
          </tr>
        `;
      }

      async function deleteCoordinator(coordinatorId, coordinatorName) {
        // Show confirmation dialog
        const confirmed = confirm(`Tem a certeza que deseja eliminar o coordenador "${coordinatorName}"?\n\nEsta ação não pode ser desfeita.`);
        
        if (!confirmed) {
          return;
        }

        try {
          const result = await window.apiClient.deleteCoordinator(coordinatorId);
          
          if (result.success) {
            // Show success message temporarily
            showSuccess(result.message);
            
            // Reload the coordinators list after a short delay
            setTimeout(() => {
              loadCoordinators();
            }, 1500);
          } else {
            showError('Erro ao eliminar coordenador: ' + result.error);
          }
        } catch (error) {
          console.error('Error deleting coordinator:', error);
          showError('Erro de conexão ao eliminar coordenador.');
        }
      }

      function showSuccess(message) {
        const tbody = document.getElementById('coordinators-tbody');
        const loadingRow = document.getElementById('loading-row');
        
        if (loadingRow) {
          loadingRow.remove();
        }
        
        tbody.innerHTML = `
          <tr>
            <td colspan="8" style="text-align: center; padding: 20px; color: var(--success); background: rgba(34, 197, 94, 0.1);">
              ${message}
            </td>
          </tr>
        `;
      }

      // Add Coordinator Modal functions
      function openAddCoordinatorModal() {
        document.getElementById('addCoordinatorModal').style.display = 'flex';
        hideAddMessages();
      }

      function closeAddCoordinatorModal() {
        document.getElementById('addCoordinatorModal').style.display = 'none';
        document.getElementById('addCoordinatorForm').reset();
        hideAddMessages();
      }

      async function handleAddCoordinator(event) {
        event.preventDefault();

        const form = event.target;
        const name = form.name.value.trim();
        const age = form.age.value.trim();
        const team = form.team.value.trim();
        const mobile = form.mobile.value.trim();
        const email = form.email.value.trim();

        if (!name || !age || !team || !mobile) {
          showAddError('Por favor, preencha todos os campos obrigatórios.');
          return false;
        }

        setAddLoadingState(true);
        hideAddMessages();

        try {
          const coordinatorData = {
            name: name,
            age: age,
            team: team,
            mobile: mobile,
            email: email || null
          };

          const result = await window.apiClient.addCoordinator(coordinatorData);

          if (result.success) {
            showAddSuccess('Coordenador adicionado com sucesso!');
            closeAddCoordinatorModal();
            // Reload the coordinators list
            setTimeout(() => {
              loadCoordinators();
            }, 1500);
          } else {
            showAddError(result.error || 'Erro ao adicionar coordenador. Tente novamente.');
          }

        } catch (error) {
          console.error('Error adding coordinator:', error);
          showAddError('Erro de conexão. Tente novamente.');
        } finally {
          setAddLoadingState(false);
        }

        return false;
      }

      function setAddLoadingState(loading) {
        const btn = document.getElementById('add-submit-btn');
        const btnText = document.getElementById('add-btn-text');
        const btnLoading = document.getElementById('add-btn-loading');

        if (loading) {
          btn.disabled = true;
          btnText.style.display = 'none';
          btnLoading.style.display = 'inline';
        } else {
          btn.disabled = false;
          btnText.style.display = 'inline';
          btnLoading.style.display = 'none';
        }
      }

      function showAddError(message) {
        const errorDiv = document.getElementById('add-error-message');
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';

        const successDiv = document.getElementById('add-success-message');
        successDiv.style.display = 'none';
      }

      function showAddSuccess(message) {
        const successDiv = document.getElementById('add-success-message');
        successDiv.textContent = message;
        successDiv.style.display = 'block';

        const errorDiv = document.getElementById('add-error-message');
        errorDiv.style.display = 'none';
      }

      function hideAddMessages() {
        document.getElementById('add-error-message').style.display = 'none';
        document.getElementById('add-success-message').style.display = 'none';
      }

      // Edit Coordinator Modal functions
      function editCoordinator(coordinatorId) {
        // Find the coordinator data from the current coordinators list
        const coordinator = currentCoordinatorsList.find(c => c.coordinatorId === coordinatorId);
        
        if (!coordinator) {
          showError('Coordenador não encontrado.');
          return;
        }

        currentEditingCoordinatorId = coordinatorId;

        // Populate the form with coordinator data
        document.getElementById('edit-name').value = coordinator.name || '';
        document.getElementById('edit-age').value = coordinator.age || '';
        document.getElementById('edit-team').value = coordinator.team || '';
        document.getElementById('edit-mobile').value = coordinator.mobile || '';
        document.getElementById('edit-email').value = coordinator.email || '';

        // Show the modal
        document.getElementById('editCoordinatorModal').style.display = 'flex';
        hideEditMessages();
      }

      function closeEditCoordinatorModal() {
        document.getElementById('editCoordinatorModal').style.display = 'none';
        currentEditingCoordinatorId = null;
        hideEditMessages();
      }

      async function handleEditCoordinator(event) {
        event.preventDefault();

        if (!currentEditingCoordinatorId) {
          showEditError('ID do coordenador não encontrado.');
          return false;
        }

        const form = event.target;
        const name = form.name.value.trim();
        const age = form.age.value.trim();
        const team = form.team.value.trim();
        const mobile = form.mobile.value.trim();
        const email = form.email.value.trim();

        if (!name || !age || !team || !mobile) {
          showEditError('Por favor, preencha todos os campos obrigatórios.');
          return false;
        }

        setEditLoadingState(true);
        hideEditMessages();

        try {
          const coordinatorData = {
            name: name,
            age: age,
            team: team,
            mobile: mobile,
            email: email || null
          };

          const result = await window.apiClient.updateCoordinator(currentEditingCoordinatorId, coordinatorData);

          if (result.success) {
            showEditSuccess('Coordenador atualizado com sucesso!');
            closeEditCoordinatorModal();
            // Reload the coordinators list
            setTimeout(() => {
              loadCoordinators();
            }, 1500);
          } else {
            showEditError(result.error || 'Erro ao atualizar coordenador. Tente novamente.');
          }

        } catch (error) {
          console.error('Error updating coordinator:', error);
          showEditError('Erro de conexão. Tente novamente.');
        } finally {
          setEditLoadingState(false);
        }

        return false;
      }

      function setEditLoadingState(loading) {
        const btn = document.getElementById('edit-submit-btn');
        const btnText = document.getElementById('edit-btn-text');
        const btnLoading = document.getElementById('edit-btn-loading');

        if (loading) {
          btn.disabled = true;
          btnText.style.display = 'none';
          btnLoading.style.display = 'inline';
        } else {
          btn.disabled = false;
          btnText.style.display = 'inline';
          btnLoading.style.display = 'none';
        }
      }

      function showEditError(message) {
        const errorDiv = document.getElementById('edit-error-message');
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';

        const successDiv = document.getElementById('edit-success-message');
        successDiv.style.display = 'none';
      }

      function showEditSuccess(message) {
        const successDiv = document.getElementById('edit-success-message');
        successDiv.textContent = message;
        successDiv.style.display = 'block';

        const errorDiv = document.getElementById('edit-error-message');
        errorDiv.style.display = 'none';
      }

      function hideEditMessages() {
        document.getElementById('edit-error-message').style.display = 'none';
        document.getElementById('edit-success-message').style.display = 'none';
      }

      document.addEventListener('DOMContentLoaded', () => {
        const yearEl = document.getElementById('year');
        if (yearEl) yearEl.textContent = String(new Date().getFullYear());

        checkAuth();
        loadCoordinators();
        
        // Event listeners para filtros
        const nameFilter = document.getElementById('name-filter');
        const teamFilter = document.getElementById('team-filter');
        const clearFiltersBtn = document.getElementById('clear-filters');
        
        if (nameFilter) {
          nameFilter.addEventListener('input', filterCoordinators);
        }
        
        if (teamFilter) {
          teamFilter.addEventListener('change', filterCoordinators);
        }
        
        if (clearFiltersBtn) {
          clearFiltersBtn.addEventListener('click', clearFilters);
        }
      });
    </script>
  </body>
</html>